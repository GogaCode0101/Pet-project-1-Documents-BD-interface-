-- Аналитические запросы

-- 1. Анализ качества работ по подрядчикам
SELECT 
    л.фио as подрядчик,
    COUNT(ас.id) as количество_актов,
    COUNT(CASE WHEN ас.качество_работ = 'Отличное' THEN 1 END) as отличное_качество,
    COUNT(CASE WHEN ас.качество_работ = 'Хорошее' THEN 1 END) as хорошее_качество,
    COUNT(CASE WHEN ас.качество_работ = 'Удовлетворительное' THEN 1 END) as удовлетворительное_качество
FROM акты_сдачи_приемки_работ ас
JOIN договоры_подряда дп ON ас.договор_id = дп.id
JOIN стороны_договора_подряда сдп ON дп.id = сдп.договор_id
JOIN лица л ON сдп.лицо_id = л.id
WHERE сдп.роль = 'Подрядчик'
GROUP BY л.фио
ORDER BY количество_актов DESC;

-- 2. Статистика по договорам подряда
SELECT 
    COUNT(*) as количество_договоров,
    SUM(сумма_договора) as общая_сумма,
    AVG(сумма_договора) as средняя_сумма,
    MIN(дата_заключения) as первый_договор,
    MAX(дата_заключения) as последний_договор
FROM договоры_подряда;

-- 3. Статистика по качеству работ
SELECT 
    качество_работ,
    COUNT(*) as количество_актов,
    AVG(общая_сумма) as средняя_сумма,
    MIN(общая_сумма) as минимальная_сумма,
    MAX(общая_сумма) as максимальная_сумма
FROM акты_сдачи_приемки_работ
GROUP BY качество_работ
ORDER BY количество_актов DESC;

-- 4. Анализ дополнительных соглашений
SELECT 
    дп.номер_договора,
    COUNT(дсп.id) as количество_соглашений,
    SUM(дсп.сумма_изменений) as общая_сумма_изменений,
    AVG(дсп.сумма_изменений) as средняя_сумма_изменений
FROM договоры_подряда дп
LEFT JOIN дополнительные_соглашения_подряд дсп ON дп.id = дсп.договор_id
GROUP BY дп.id, дп.номер_договора
ORDER BY количество_соглашений DESC;

-- Мониторинг и контроль

-- 5. Акты с просроченным гарантийным сроком
SELECT 
    ас.id,
    ас.дата_составления,
    ас.срок_гарантии,
    дп.номер_договора,
    л.фио as подрядчик
FROM акты_сдачи_приемки_работ ас
JOIN договоры_подряда дп ON ас.договор_id = дп.id
JOIN стороны_договора_подряда сдп ON дп.id = сдп.договор_id
JOIN лица л ON сдп.лицо_id = л.id
WHERE сдп.роль = 'Подрядчик'
    AND (ас.дата_составления + ас.срок_гарантии * INTERVAL '1 day') < CURRENT_DATE;

-- 6. Договоры с наибольшим количеством изменений
SELECT 
    дп.номер_договора,
    COUNT(дсп.id) as количество_соглашений,
    SUM(дсп.сумма_изменений) as общая_сумма_изменений,
    (SUM(дсп.сумма_изменений) / дп.сумма_договора * 100) as процент_изменений
FROM договоры_подряда дп
LEFT JOIN дополнительные_соглашения_подряд дсп ON дп.id = дсп.договор_id
GROUP BY дп.id, дп.номер_договора, дп.сумма_договора
HAVING COUNT(дсп.id) > 0
ORDER BY процент_изменений DESC;

-- 7. Анализ просроченных платежей
SELECT 
    дп.номер_договора,
    дп.сумма_договора,
    дп.дата_заключения,
    л.фио as заказчик,
    CURRENT_DATE - дп.дата_заключения as дней_с_заключения,
    CASE 
        WHEN CURRENT_DATE - дп.дата_заключения > 30 THEN 'Просрочен'
        ELSE 'Активен'
    END as статус_договора
FROM договоры_подряда дп
JOIN стороны_договора_подряда сдп ON дп.id = сдп.договор_id
JOIN лица л ON сдп.лицо_id = л.id
WHERE сдп.роль = 'Заказчик'
ORDER BY дней_с_заключения DESC;

-- Анализ клиентов

-- 8. Наиболее активные заказчики
SELECT 
    л.фио as заказчик,
    COUNT(дп.id) as количество_договоров,
    SUM(дп.сумма_договора) as общая_сумма_договоров,
    AVG(дп.сумма_договора) as средняя_сумма_договора
FROM договоры_подряда дп
JOIN стороны_договора_подряда сдп ON дп.id = сдп.договор_id
JOIN лица л ON сдп.лицо_id = л.id
WHERE сдп.роль = 'Заказчик'
GROUP BY л.фио
ORDER BY общая_сумма_договоров DESC;

-- 9. Анализ заказчиков по количеству договоров
SELECT 
    COUNT(*) as количество_договоров,
    COUNT(DISTINCT л.id) as количество_заказчиков
FROM договоры_подряда дп
JOIN стороны_договора_подряда сдп ON дп.id = сдп.договор_id
JOIN лица л ON сдп.лицо_id = л.id
WHERE сдп.роль = 'Заказчик'
GROUP BY л.фио
ORDER BY количество_договоров DESC;

-- 10. Динамика работы с заказчиками
SELECT 
    л.фио as заказчик,
    DATE_TRUNC('month', дп.дата_заключения) as месяц,
    COUNT(дп.id) as количество_договоров,
    SUM(дп.сумма_договора) as сумма_договоров
FROM договоры_подряда дп
JOIN стороны_договора_подряда сдп ON дп.id = сдп.договор_id
JOIN лица л ON сдп.лицо_id = л.id
WHERE сдп.роль = 'Заказчик'
GROUP BY л.фио, DATE_TRUNC('month', дп.дата_заключения)
ORDER BY л.фио, месяц DESC; 